<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Team Hours Tracker</title>

        <style>
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }
            body {
                font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                min-height: 100vh;
                padding: 20px;
            }
            .container {
                max-width: 700px;
                margin: 0 auto;
            }
            h1 {
                color: white;
                text-align: center;
                margin-bottom: 10px;
                font-size: 28px;
            }
            .person-name {
                color: rgba(255, 255, 255, 0.9);
                text-align: center;
                margin-bottom: 20px;
                font-size: 20px;
            }
            .period-selector {
                text-align: center;
                margin-bottom: 20px;
            }
            #week-select {
                padding: 6px 12px;
                border-radius: 6px;
                border: none;
            }
            .loading,
            .error-card {
                background: white;
                border-radius: 16px;
                padding: 40px;
                text-align: center;
                box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            }
            .spinner {
                border: 4px solid #f3f3f3;
                border-top: 4px solid #667eea;
                border-radius: 50%;
                width: 40px;
                height: 40px;
                animation: spin 1s linear infinite;
                margin: 0 auto 20px;
            }
            @keyframes spin {
                0% {
                    transform: rotate(0deg);
                }
                100% {
                    transform: rotate(360deg);
                }
            }
            .error-card {
                display: none;
                color: #c00;
            }
            .hours-card {
                background: white;
                border-radius: 16px;
                padding: 25px;
                box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
                display: none;
            }
            .hours-card.active {
                display: block;
            }
            .period {
                background: #f0f4ff;
                padding: 10px 15px;
                border-radius: 8px;
                margin-bottom: 20px;
                color: #667eea;
                font-weight: 600;
            }
            .task-list {
                list-style: none;
            }
            .task-item {
                display: flex;
                justify-content: space-between;
                padding: 12px 0;
                border-bottom: 1px solid #eee;
            }
            .task-item:last-child {
                border-bottom: none;
            }
            .task-hours {
                font-weight: 600;
                color: #667eea;
            }
            .total-row {
                display: flex;
                justify-content: space-between;
                margin-top: 20px;
                padding-top: 15px;
                border-top: 2px solid #667eea;
                font-size: 18px;
                font-weight: 700;
            }
            .note {
                background: #fff3e0;
                padding: 10px 15px;
                border-radius: 8px;
                margin-top: 15px;
                font-size: 13px;
            }
            .team-lead-section {
                margin-top: 30px;
                padding-top: 20px;
                border-top: 2px dashed #ddd;
                display: none;
            }
            .team-lead-title {
                font-size: 14px;
                color: #888;
                margin-bottom: 15px;
                text-transform: uppercase;
            }
            .summary-table {
                width: 100%;
                border-collapse: collapse;
            }
            .summary-table th,
            .summary-table td {
                padding: 10px;
                border-bottom: 1px solid #eee;
            }
            .summary-table th {
                background: #f8f9fa;
                font-weight: 600;
            }
            .summary-table td:last-child {
                text-align: right;
                font-weight: 600;
                color: #667eea;
            }
        </style>
    </head>

    <body>
        <div class="container">
            <h1>üìä Team Hours</h1>
            <div class="person-name" id="person-name"></div>

            <div class="period-selector">
                <label for="week-select" style="color: white; font-weight: 600">
                    Select Week:
                </label>
                <select id="week-select">
                    <option value="Team Hours">My Hours</option>
                    <option value="Last Week">Last Week</option>
                </select>
            </div>

            <div class="loading" id="loading">
                <div class="spinner"></div>
                <div>Loading your hours...</div>
            </div>

            <div class="error-card" id="error">
                <h3>‚ö†Ô∏è Error</h3>
                <p id="error-message"></p>
            </div>

            <div class="hours-card" id="hours-display">
                <div class="period" id="period-display"></div>
                <ul class="task-list" id="task-list"></ul>

                <div class="total-row">
                    <span>Total Hours</span>
                    <span id="total-hours"></span>
                </div>

                <div id="note-container"></div>

                <div class="team-lead-section" id="team-lead-section">
                    <div class="team-lead-title">
                        üë• Interview Summary (Team Lead View)
                    </div>
                    <table class="summary-table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Interviews</th>
                                <th>Async Interviews</th>
                                <th>Total</th>
                            </tr>
                        </thead>
                        <tbody id="summary-body"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <script>
            const TEAM_LEADS = ["karolina", "ira", "ksenia"];
            const GOOGLE_SHEET_BASE_URL =
                "https://docs.google.com/spreadsheets/d/1LVP3gbLtLxiKkxtHEWkCwXcdznsDv4IT/gviz/tq?tqx=out:json";

            const urlParams = new URLSearchParams(window.location.search);
            const person = urlParams.get("person")?.toLowerCase();

            const loadingEl = document.getElementById("loading");
            const errorEl = document.getElementById("error");
            const errorMessageEl = document.getElementById("error-message");
            const hoursCard = document.getElementById("hours-display");
            const personNameEl = document.getElementById("person-name");
            const periodDisplay = document.getElementById("period-display");
            const taskList = document.getElementById("task-list");
            const totalHours = document.getElementById("total-hours");
            const noteContainer = document.getElementById("note-container");
            const teamLeadSection =
                document.getElementById("team-lead-section");
            const summaryBody = document.getElementById("summary-body");
            const weekSelect = document.getElementById("week-select");

            function showError(message) {
                loadingEl.style.display = "none";
                errorEl.style.display = "block";
                errorMessageEl.textContent = message;
            }

            function getSheetURL(sheetName) {
                return `${GOOGLE_SHEET_BASE_URL}&sheet=${encodeURIComponent(sheetName)}`;
            }

            async function fetchData(sheetName) {
                loadingEl.style.display = "block";
                hoursCard.classList.remove("active");
                errorEl.style.display = "none";

                try {
                    const res = await fetch(getSheetURL(sheetName));
                    const text = await res.text();
                    const json = JSON.parse(
                        text.substring(47, text.length - 2),
                    );
                    displayData(json);
                } catch (err) {
                    showError(
                        "Could not load data. Check Google Sheet settings.",
                    );
                }
            }

            function displayData(json) {
                const rows = json.table.rows;
                let personData = [];
                let allPeopleData = {};
                let displayName = "";
                let currentPeriod = "";
                let personNote = "";

                const [nameCol, periodCol, taskCol, hoursCol, noteCol] = [
                    0, 1, 2, 3, 4,
                ];

                rows.forEach((row) => {
                    if (!row.c[nameCol] || !row.c[nameCol].v) return;

                    const name = row.c[nameCol].v
                        .toString()
                        .toLowerCase()
                        .trim();
                    const task =
                        row.c[taskCol]?.v?.toString().toLowerCase() || "";
                    const hours = row.c[hoursCol]?.v
                        ? parseFloat(row.c[hoursCol].v)
                        : 0;
                    const period = row.c[periodCol]?.v || "";
                    const note = row.c[noteCol]?.v || "";

                    if (!allPeopleData[name]) {
                        allPeopleData[name] = {
                            displayName: row.c[nameCol].v,
                            interviews: 0,
                            async: 0,
                        };
                    }

                    const normalizedTask = task.trim().toLowerCase();

                    if (normalizedTask === "interviews") {
                        allPeopleData[name].interviews += hours;
                    }

                    if (normalizedTask === "asynchronous interviews") {
                        allPeopleData[name].async += hours;
                    }

                    if (name === person) {
                        displayName = row.c[nameCol].v;
                        currentPeriod = period;
                        if (note) personNote = note;
                        personData.push({
                            task: row.c[taskCol]?.v || "",
                            hours,
                        });
                    }
                });

                loadingEl.style.display = "none";

                if (personData.length === 0) {
                    showError(`No hours found for "${person}".`);
                    return;
                }

                personNameEl.textContent = `Welcome, ${displayName}!`;
                periodDisplay.textContent = `üìÖ Period: ${currentPeriod}`;

                taskList.innerHTML = personData
                    .map(
                        (item) =>
                            `<li class="task-item">
            <span>${item.task}</span>
            <span class="task-hours">${item.hours}h</span>
        </li>`,
                    )
                    .join("");

                totalHours.textContent =
                    personData.reduce((sum, t) => sum + t.hours, 0) + " hours";

                noteContainer.innerHTML = personNote
                    ? `<div class="note">üìù ${personNote}</div>`
                    : "";

                if (TEAM_LEADS.includes(person)) {
                    teamLeadSection.style.display = "block";
                    summaryBody.innerHTML = "";

                    Object.keys(allPeopleData)
                        .sort()
                        .forEach((name) => {
                            const data = allPeopleData[name];
                            const total = data.interviews + data.async;

                            if (total > 0) {
                                const tr = document.createElement("tr");
                                tr.innerHTML = `
                    <td>${data.displayName}</td>
                    <td>${data.interviews}h</td>
                    <td>${data.async}h</td>
                    <td>${total}h</td>
                `;
                                summaryBody.appendChild(tr);
                            }
                        });
                } else {
                    teamLeadSection.style.display = "none";
                }

                hoursCard.classList.add("active");
            }

            weekSelect.addEventListener("change", () =>
                fetchData(weekSelect.value),
            );

            if (!person) {
                showError("Use link like: ?person=karolina");
            } else {
                fetchData(weekSelect.value);
            }
        </script>
    </body>
</html>
